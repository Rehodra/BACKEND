<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viewing <%= user.userName %>'s Profile - Nimi Blog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style> 
    body { font-family: 'Inter', sans-serif; } 
    .bg-gradient-dark { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
    .card-dark { background-color: #1f2937; }
    .data-display {
      background-color: rgba(31, 41, 55, 0.7);
      border-left: 3px solid #374151;
      padding: 0.75rem 1rem;
      color: #f3f4f6; 
      min-height: 48px;
    }
    .post-link:hover { border-left-color: #0ea5e9; }
    .social-icon { transition: transform 0.2s, color 0.2s; }
    .social-icon:hover { transform: scale(1.1); }
  </style>
</head>
<body class="bg-gradient-dark min-h-screen antialiased p-8 lg:p-12">

  <!-- Header -->
  <header class="mb-10 flex justify-between items-center max-w-5xl mx-auto">
    <h1 class="text-3xl font-extrabold text-sky-500 flex items-center">
      <i class="fas fa-feather-alt mr-3"></i> Nimi Blog
    </h1>
    <nav>
      <a href="/dashboard" class="text-gray-300 hover:text-sky-500 font-medium transition duration-150 mr-6">
        <i class="fas fa-tachometer-alt mr-1"></i> Dashboard
      </a>
      <a href="/logout" class="text-gray-300 hover:text-red-500 font-medium transition duration-150">
        <i class="fas fa-sign-out-alt mr-1"></i> Log Out
      </a>
    </nav>
  </header>

  <div class="max-w-5xl mx-auto">

    <!-- Profile Card -->
    <div class="card-dark rounded-xl p-8 mb-8 shadow-2xl flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
      <div class="relative flex-shrink-0">
        <img 
          src="<%= user.profileImage || `https://via.placeholder.com/150/0ea5e9/ffffff?text=${user.initials}` %>" 
          alt="<%= user.userName %>'s Profile Picture"
          class="w-32 h-32 rounded-full object-cover border-4 border-sky-600 shadow-xl">
        <span class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-gray-900" title="Online"></span>
      </div>

      <div class="text-center md:text-left flex-grow">
        <h2 class="text-4xl font-bold text-white tracking-tight"><%= user.userName %></h2>
        <p class="text-xl text-gray-400 mt-1"><%= user.title || 'Aspiring Blogger' %></p>
        <p class="text-gray-400 mt-4 max-w-lg"><i class="fas fa-quote-left mr-2 text-sky-500"></i> 
          <%= user.bio || 'This user has not yet written a biography.' %>
        </p>
      </div>
      
     <!-- FOLLOW / FOLLOWING BUTTON + Follower Count -->
<div class="md:self-start flex flex-col space-y-2 pt-4">
  <% const isFollowing = user.follower && user.follower.some(f => f.toString() === loggedInUserId); %>

  <% if (isFollowing) { %>
    <!--  FOLLOWING -->
    <button 
      id="unfollowBtn"
      data-user-id="<%= user._id %>"
      class="inline-flex items-center px-6 py-2 font-semibold rounded-lg transition duration-200 
             hover:-translate-y-px shadow-lg border-2 bg-gray-800 border-sky-400 hover:bg-sky-700 
             text-white shadow-sky-500/30">
      <i class="fas fa-user-check mr-2"></i> Following
    </button>
  <% } else { %>

    <button 
      id="followBtn"
      data-user-id="<%= user._id %>"
      class="inline-flex items-center px-6 py-2 font-semibold rounded-lg transition duration-200 
             hover:-translate-y-px shadow-lg border-2 bg-sky-600 border-sky-400 hover:bg-sky-600 
             text-white shadow-sky-400/40">
      <i class="fas fa-user-plus mr-2"></i> Follow
    </button>
  <% } %>

  <span id="followerCount" class="text-gray-300 text-sm mt-1">
    Followers: <%= followersCount %>
  </span>
</div>


    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <!-- LEFT: Stats -->
      <div class="lg:col-span-1 space-y-6">
        <div class="card-dark p-6 rounded-xl shadow-xl">
          <h3 class="text-2xl font-semibold text-white mb-5 border-b border-gray-700 pb-3">Blogger Statistics</h3>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Member Since</label>
            <p class="data-display rounded-lg text-sm"><%= (user.createdAt ? user.createdAt.toDateString() : 'Date unavailable') %></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Total Posts</label>
            <p class="data-display rounded-lg text-sm"><%= user.posts ? user.posts.length : 0 %></p>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Followers</label>
            <p class="data-display rounded-lg text-sm"><%= followersCount %></p>
          </div>

          <div class="mt-2">
            <label class="block text-sm font-medium text-gray-400 mb-1">Following</label>
            <p class="data-display rounded-lg text-sm"><%= user.following ? user.following.length : 0 %></p>
          </div>
        </div>

        <!-- Social Links -->
        <div class="card-dark p-6 rounded-xl shadow-xl">
          <h3 class="text-2xl font-semibold text-white mb-5 border-b border-gray-700 pb-3">Connect</h3>
          <div class="flex space-x-6 justify-center">
            <a href='https://www.linkedin.com/in/mounasuvra-banerjee-3352b7378/' target="_blank" class="text-gray-300 hover:text-blue-500 social-icon text-3xl" title="LinkedIn">
              <i class="fab fa-linkedin"></i>
            </a>
            <a href="https://github.com/Rehodra" target="_blank" class="text-gray-300 hover:text-purple-400 social-icon text-3xl" title="GitHub">
              <i class="fab fa-github"></i>
            </a>
          </div>
          <p class="text-center text-sm text-gray-500 mt-4">Follow their professional journey.</p>
        </div>
      </div>

      <!-- RIGHT: Recent Posts -->
      <div class="lg:col-span-2">
        <div class="card-dark p-6 rounded-xl shadow-xl">
          <h3 class="text-2xl font-semibold text-white mb-5 border-b border-gray-700 pb-3">
            Recent Posts (<%= user.posts ? user.posts.length : 0 %>)
          </h3>

          <% if ( user.posts.length > 0) { %>
                        <ul class="space-y-4">
                            <% user.posts.forEach(post => { %>
                                <li class="post-link transition duration-150 border-l-4 border-transparent pl-4 py-2 hover:bg-gray-800 rounded-md">
                                    <a href="/single-blog/<%= post.id %>" class="block">
                                        <p class="text-lg font-medium text-white hover:text-sky-400 transition duration-150 truncate"><%= post.title %></p>
                                        <p class="text-sm text-gray-400 mt-1 flex items-center">
                                            <i class="fas fa-calendar-alt mr-2 text-sky-500"></i> <%= post.createdAt.toDateString() %> 
                                            <span class="mx-3 text-gray-600">|</span>
                                            <i class="fas fa-thumbs-up mr-2 text-sky-500"></i> <%= post.likes.length %> Likes
                                        </p>
                                    </a>
                                </li>
                            <% }) %>
                        </ul>
                        <div class="mt-6 text-center border-t border-gray-800 pt-4">
                            <a href="/user/<%= user._id %>/view-all-posts-of-writer" class="text-sky-500 hover:text-sky-400 font-medium transition duration-150 flex items-center justify-center">
                                View All <%= user.userName %>'s Posts <i class="fas fa-arrow-right ml-2"></i>
                            </a>
                        </div>
                    <% } else { %>
                        <div class="text-center py-10 text-gray-500 mt-4">
                            <i class="fas fa-pen-nib text-4xl mb-3 text-gray-600"></i>
                            <p class="text-lg">No posts published yet. Start sharing your first story!</p>
                        </div>
                    <% } %>
        </div>
      </div>
    </div>
  </div>

  <script>
document.addEventListener("click", async (e) => {
  const followBtn = e.target.closest("#followBtn");
  const unfollowBtn = e.target.closest("#unfollowBtn");
  const followerCountSpan = document.getElementById("followerCount");

  if (!followBtn && !unfollowBtn) return;

  const btn = followBtn || unfollowBtn;
  const userId = btn.dataset.userId;
  const currentCount = parseInt(followerCountSpan.innerText.split(": ")[1]);

  try {
    const endpoint = followBtn ? `/user/${userId}/follow` : `/user/${userId}/unfollow`;
    const res = await fetch(endpoint, { method: "POST" });
    const data = await res.json();

    if (data.success) {
      if (data.following) {
        //  Switch to “Following”
        btn.id = "unfollowBtn";
        btn.className =
          "inline-flex items-center px-6 py-2 font-semibold rounded-lg transition duration-200 hover:-translate-y-px shadow-lg border-2 bg-gray-800 border-sky-400 hover:bg-sky-700 text-white shadow-sky-500/30";
        btn.innerHTML = '<i class="fas fa-user-check mr-2"></i> Following';
        followerCountSpan.innerText = "Followers: " + (currentCount + 1);
      } else {
        //  Switch to “Follow”
        btn.id = "followBtn";
        btn.className =
          "inline-flex items-center px-6 py-2 font-semibold rounded-lg transition duration-200 hover:-translate-y-px shadow-lg border-2 bg-sky-500 border-sky-400 hover:bg-sky-600 text-white shadow-sky-400/40";
        btn.innerHTML = '<i class="fas fa-user-plus mr-2"></i> Follow';
        followerCountSpan.innerText = "Followers: " + (currentCount - 1);
      }
    }
  } catch (err) {
    console.error("Error toggling follow:", err);
  }
});
</script>



</body>
</html>
